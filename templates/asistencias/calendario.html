{% extends 'base.html' %}
{% block title %}Calendario · {{ diplomatura.nombre }}{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h1>Calendario · {{ diplomatura.nombre }}</h1>
    <div style="display: flex; gap: 10px;">
        {% if es_referente %}
        <a class="btn secondary" href="{% url 'asistencias:exportar_asistencia_diplomatura' diplomatura.id %}">Exportar
            Todo</a>
        {% endif %}
        <a class="btn secondary" href="{% url 'asistencias:home' %}">Volver</a>
    </div>
</div>

<div class="card">
    <div id="calendar"></div>
</div>

<!-- FullCalendar -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'es',
            selectable: true,
            dateClick: function (info) {
                // Solo si es docente o superior (nivel >= 2)
                {% if request.user.nivel >= 2 %}
                openModal(info.dateStr);
                {% endif %}
            },
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: [
                {% for e in eventos %}
        {
                title: "{{ e.title }}",
                start: "{{ e.start }}",
                url: "{% if e.can_edit %}{% url 'asistencias:editar_clase' e.id %}{% else %}#{% endif %}",
                color: "{{ e.color }}",
                extendedProps: {
                    materia_id: "{{ e.materia_id }}",
                    can_edit: {% if e.can_edit %}true{% else %}false{% endif %},
        link_clase: "{{ e.link_clase|escapejs }}",
        tema: "{{ e.tema|escapejs }}",
        hora_inicio: "{{ e.hora_inicio }}",
        hora_fin: "{{ e.hora_fin }}",
        stats: {% if e.stats %}{ presentes: { { e.stats.presentes } }, inscriptos: { { e.stats.inscriptos } } } {% else %} null{% endif %}
          }
        },
    {% endfor %}
      ],
    eventClick: function (info) {
        if (info.event.extendedProps.can_edit) {
            // Allow default behavior
        } else {
            info.jsEvent.preventDefault();
            openModalDetalle(info.event);
        }
    }
    });
    calendar.render();
  });
</script>

<!-- Modal para elegir materia al crear clase desde calendario -->
<div id="modal-materia" class="modal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content"
        style="background-color: #1e1e1e; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 8px;">
        <span class="close"
            style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h3>Crear Clase</h3>
        <p>Seleccioná la materia para el día <span id="modal-fecha-display"></span>:</p>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            {% for m in materias_creables %}
            <button class="btn secondary" onclick="crearClase('{{ m.id }}')">{{ m.nombre }}</button>
            {% empty %}
            <p>No tenés materias asignadas para crear clases.</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Modal Detalle de Clase (para alumnos) -->
<div id="modal-detalle-clase" class="modal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content"
        style="background-color: #1e1e1e; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px;">
        <span class="close-detalle"
            style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h3 id="detalle-titulo"></h3>
        <p><strong>Horario:</strong> <span id="detalle-horario"></span></p>
        <p><strong>Tema:</strong> <span id="detalle-tema"></span></p>
        <p id="detalle-link-container" style="display:none;">
            <strong>Link/Detalle:</strong> <br>
            <a id="detalle-link" href="#" target="_blank" style="color: var(--accent2); word-break: break-all;"></a>
        </p>
    </div>
</div>

<script>
    var selectedDate = null;
    var modal = document.getElementById("modal-materia"); // Modal de crear clase
    var span = document.getElementsByClassName("close")[0];

    function openModal(dateStr) {
        selectedDate = dateStr;
        document.getElementById("modal-fecha-display").innerText = dateStr;
        modal.style.display = "block";
    }

    if (span) {
        span.onclick = function () {
            modal.style.display = "none";
        }
    }

    function crearClase(materiaId) {
        // Redirigir a crear clase con la fecha
        var url = "{% url 'asistencias:crear_clase' 0 %}".replace('0', materiaId);
        window.location.href = url + "?fecha=" + selectedDate;
    }

    function openModalDetalle(event) {
        document.getElementById("detalle-titulo").innerText = event.title;
        document.getElementById("detalle-horario").innerText = event.extendedProps.hora_inicio + " - " + event.extendedProps.hora_fin;
        document.getElementById("detalle-tema").innerText = event.extendedProps.tema || "Sin tema especificado";

        var linkContainer = document.getElementById("detalle-link-container");
        var linkElement = document.getElementById("detalle-link");

        if (event.extendedProps.link_clase) {
            linkElement.href = event.extendedProps.link_clase;
            linkElement.innerText = event.extendedProps.link_clase;
            linkContainer.style.display = "block";
        } else {
            linkContainer.style.display = "none";
        }

        document.getElementById("modal-detalle-clase").style.display = "block";
    }

    // Close modal logic
    document.addEventListener('DOMContentLoaded', function () {
        // Logic for detail modal close
        var modalDetalle = document.getElementById("modal-detalle-clase");
        var spanDetalle = document.getElementsByClassName("close-detalle")[0];

        if (spanDetalle) {
            spanDetalle.onclick = function () {
                modalDetalle.style.display = "none";
            }
        }

        // Logic for create modal close (if clicked outside)
        var modalCreate = document.getElementById("modal-materia");

        window.onclick = function (event) {
            if (event.target == modalDetalle) {
                modalDetalle.style.display = "none";
            }
            if (event.target == modalCreate) {
                modalCreate.style.display = "none";
            }
        }
    });
</script>
<style>
    #calendar {
        max-width: 100%;
        margin: 0 auto;
        font-family: var(--font-family);
    }

    .fc-event {
        cursor: pointer;
    }
</style>
{% endblock %}