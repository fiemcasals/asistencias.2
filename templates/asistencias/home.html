{% extends 'base.html' %}
{% block title %}Inicio{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
  <h1>Inicio</h1>
  <div style="display: flex; gap: 10px;">
    {% if request.user.nivel >= 3 %}
    <a class="btn" href="{% url 'asistencias:crear_diplomatura' %}">+ Nueva Diplomatura</a>
    {% endif %}
    {% if request.user.nivel >= 2 %}
    <a class="btn" href="{% url 'asistencias:crear_materia' %}">+ Nueva Materia</a>
    {% endif %}
  </div>
</div>

{% if request.user.is_authenticated %}
<div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
  <a class="btn" href="{% url 'asistencias:perfil' %}">ðŸ‘¤ Mi Perfil</a>
</div>

{% if mostrar_calendario_general %}
<div class="card">
  <h2>Calendario de Clases</h2>
  <div id="calendar"></div>
</div>

<!-- FullCalendar -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var calendarEl = document.getElementById('calendar');
    var isMobile = window.innerWidth < 768;

    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'es',
      selectable: true,
      dateClick: function (info) {
        // Solo si hay materias creables (es profe)
        {% if materias_creables %}
        openModal(info.dateStr);
        {% endif %}
      },
      headerToolbar: {
        left: isMobile ? 'prev,next' : 'prev,next today',
        center: 'title',
        right: isMobile ? 'dayGridMonth,timeGridDay' : 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      height: 'auto',
      contentHeight: 'auto',
      aspectRatio: isMobile ? 0.8 : 1.35,
      events: [
        {% for e in eventos %}
        {
        title: "{{ e.title }}",
        start: "{{ e.start }}",
        url: "{% if e.can_edit %}{% url 'asistencias:editar_clase' e.id %}{% else %}#{% endif %}",
        color: "{{ e.color }}",
        extendedProps: {
          materia_id: "{{ e.materia_id }}",
          can_edit: {% if e.can_edit %}true{% else %}false{% endif %}
          }
        },
    {% endfor %}
      ],
    eventClick: function (info) {
      if (info.event.extendedProps.can_edit) {
        // Allow default behavior (navigate to URL)
      } else {
        info.jsEvent.preventDefault(); // Don't navigate if student
      }
    },
    windowResize: function (view) {
      if (window.innerWidth < 768) {
        calendar.setOption('headerToolbar', {
          left: 'prev,next',
          center: 'title',
          right: 'dayGridMonth,timeGridDay'
        });
        calendar.setOption('aspectRatio', 0.8);
      } else {
        calendar.setOption('headerToolbar', {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        });
        calendar.setOption('aspectRatio', 1.35);
      }
    }
    });
  calendar.render();
  });
</script>
<style>
  #calendar {
    max-width: 100%;
    margin: 0 auto;
    font-family: var(--font-family);
  }

  .fc-event {
    cursor: pointer;
  }

  /* Mobile adjustments for calendar */
  @media (max-width: 768px) {
    .fc-toolbar {
      flex-direction: column;
      gap: 10px;
    }

    .fc-toolbar-title {
      font-size: 1.2em !important;
    }
  }
</style>
{% endif %}

<!-- Modal para elegir materia al crear clase desde calendario -->
<div id="modal-materia" class="modal"
  style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-content"
    style="background-color: #1e1e1e; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 8px;">
    <span class="close"
      style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
    <h3>Crear Clase</h3>
    <p>SeleccionÃ¡ la materia para el dÃ­a <span id="modal-fecha-display"></span>:</p>
    <div style="display: flex; flex-direction: column; gap: 10px;">
      {% for m in materias_creables %}
      <button class="btn secondary" onclick="crearClase('{{ m.id }}')">{{ m.nombre }}</button>
      {% empty %}
      <p>No tenÃ©s materias asignadas para crear clases.</p>
      {% endfor %}
    </div>
  </div>
</div>

<script>
  var selectedDate = null;
  var modal = document.getElementById("modal-materia");
  var span = document.getElementsByClassName("close")[0];

  function openModal(dateStr) {
    selectedDate = dateStr;
    document.getElementById("modal-fecha-display").innerText = dateStr;
    modal.style.display = "block";
  }

  span.onclick = function () {
    modal.style.display = "none";
  }

  window.onclick = function (event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }

  function crearClase(materiaId) {
    // Redirigir a crear clase con la fecha
    var url = "{% url 'asistencias:crear_clase' 0 %}".replace('0', materiaId);
    window.location.href = url + "?fecha=" + selectedDate;
  }
</script>
{% endif %}

<h2>Diplomaturas</h2>

<div class="grid">
  {% for d in diplomaturas %}
  <div class="card">
    <h3>{{ d.nombre }}</h3>
    <p class="muted">CÃ³digo: {{ d.codigo }}</p>
    <p><a class="btn secondary small" href="{% url 'asistencias:calendario_diplomatura' d.id %}">ðŸ“… Ver Calendario</a>
    </p>

    <ul>
      {% for m in d.materias.all %}
      <li>
        {{ m.nombre }} â€” <a href="{% url 'asistencias:ver_clases' m.id %}">ver clases</a>
      </li>
      {% endfor %}
    </ul>
  </div>
  {% empty %}
  <p>No tenÃ©s diplomaturas asignadas.</p>
  {% endfor %}
</div>

{% endblock %}