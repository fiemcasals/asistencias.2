{% extends 'base.html' %}
{% block title %}Inicio{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
  <h1>Inicio</h1>
  <div style="display: flex; gap: 10px;">
    {% if request.user.nivel >= 3 and request.user.nivel != 6 %}
    <a class="btn" href="{% url 'asistencias:crear_diplomatura' %}">+ Nueva Diplomatura</a>
    <a class="btn" href="{% url 'asistencias:crear_materia' %}">+ Nueva Materia</a>
    {% endif %}
  </div>
</div>

{% if request.user.is_authenticated %}
<div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
  <a class="btn" href="{% url 'asistencias:perfil' %}">ğŸ‘¤ Mi Perfil</a>
</div>

{% if mostrar_calendario_general %}
<div class="card">
  <h2>Calendario de Clases</h2>
  <div id="calendar"></div>
</div>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var calendarEl = document.getElementById('calendar');
    var isMobile = window.innerWidth < 768;

    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'es',
      headerToolbar: {
        left: isMobile ? 'prev,next' : 'prev,next today',
        center: 'title',
        right: isMobile ? 'dayGridMonth,timeGridDay' : 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      height: 'auto',
      aspectRatio: isMobile ? 0.8 : 1.35,
      events: [
        {% for e in eventos %}
        {
          title: "{{ e.title|escapejs }}",
          start: "{{ e.start }}",
          color: "{{ e.color }}",
          extendedProps: {
            clase_id: "{{ e.id }}",
            tema: "{{ e.extendedProps.tema|escapejs }}",
            hora_inicio: "{{ e.extendedProps.hora_inicio }}",
            hora_fin: "{{ e.extendedProps.hora_fin }}"
          }
        },
        {% endfor %}
      ],
      eventClick: function(info) {
        info.jsEvent.preventDefault(); 
        var props = info.event.extendedProps;
        document.getElementById("detalle-titulo").innerText = info.event.title;
        document.getElementById("detalle-horario").innerText = (props.hora_inicio || "--:--") + " a " + (props.hora_fin || "--:--");
        document.getElementById("detalle-tema").innerText = props.tema || "Sin tema especificado";

        var btnEditarContainer = document.getElementById("contenedor-boton-editar");
        if ({{ request.user.nivel }} >= 2) {
            var urlEditar = "{% url 'asistencias:editar_clase' 0 %}".replace('0', props.clase_id);
            btnEditarContainer.innerHTML = `<a href="${urlEditar}" class="btn" style="background-color: #f39c12; color: white; text-decoration: none; padding: 8px 15px; border-radius: 5px; font-weight: bold;">Editar Tema</a>`;
            btnEditarContainer.style.display = "inline-block";
        } else {
            btnEditarContainer.style.display = "none";
        }
        document.getElementById("modal-detalle-clase").style.display = "block";
      }
    });
    calendar.render();
  });
</script>
{% endif %}

<div id="modal-detalle-clase" class="modal" style="display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6);">
  <div class="modal-content" style="background-color: #1e1e1e; margin: 10% auto; padding: 25px; border: 1px solid var(--accent); width: 90%; max-width: 500px; border-radius: 12px;">
    <span onclick="document.getElementById('modal-detalle-clase').style.display='none'" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
    <h2 id="detalle-titulo" style="color: var(--accent2);"></h2>
    <p><strong>ğŸ•’ Horario:</strong> <span id="detalle-horario"></span></p>
    <p><strong>ğŸ“ Tema:</strong> <br><span id="detalle-tema" style="color: #ccc;"></span></p>
    <div style="margin-top: 25px; display: flex; justify-content: flex-end; gap: 12px;">
        <div id="contenedor-boton-editar"></div>
        <button class="btn secondary small" onclick="document.getElementById('modal-detalle-clase').style.display='none'">Cerrar</button>
    </div>
  </div>
</div>

<h2 style="margin-top: 40px;">Diplomaturas</h2>
<div class="grid">
  {% for d in diplomaturas %}
  <div class="card">
    <h3>{{ d.nombre }}</h3>
    <p class="muted">CÃ³digo: {{ d.codigo }}</p>
    {% if not solo_una_diplo %}
    <p><a class="btn secondary small" href="{% url 'asistencias:calendario_diplomatura' d.id %}">ğŸ“… Ver Calendario</a></p>
    {% endif %}
    <ul>
      {% for m in d.materias.all %}
      <li>
        {{ m.nombre }} â€” <a href="{% url 'asistencias:ver_clases' m.id %}">ver materia</a>
      </li>
      {% endfor %}
    </ul>
  </div>
  {% empty %}
  <p>No tenÃ©s diplomaturas asignadas.</p>
  {% endfor %}
</div>
{% endif %}
{% endblock %}
