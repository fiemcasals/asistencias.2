{% extends 'base.html' %}
{% block title %}Inicio{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
  <h1>Inicio</h1>
  {% if request.user.nivel >= 3 %}
  <a class="btn" href="{% url 'asistencias:crear_materia' %}">+ Nueva Materia</a>
  {% endif %}
</div>

{% if request.user.is_authenticated %}
<div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
  <a class="btn" href="{% url 'asistencias:perfil' %}">ğŸ‘¤ Mi Perfil</a>
  <a class="btn" href="{% url 'asistencias:usar_token' %}">ğŸŸï¸ Canjear Token</a>
</div>

<div class="card">
  <h2>Calendario de Clases</h2>
  <div id="calendar"></div>
</div>

<!-- FullCalendar -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var calendarEl = document.getElementById('calendar');
    var isMobile = window.innerWidth < 768;

    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'es',
      headerToolbar: {
        left: isMobile ? 'prev,next' : 'prev,next today',
        center: 'title',
        right: isMobile ? 'dayGridMonth,timeGridDay' : 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      height: 'auto',
      contentHeight: 'auto',
      aspectRatio: isMobile ? 0.8 : 1.35,
      events: [
        {% for e in eventos %}
        {
        title: "{{ e.title }}",
        start: "{{ e.start }}",
        url: "{% if e.can_edit %}{% url 'asistencias:editar_clase' e.id %}{% else %}#{% endif %}",
        color: "{{ e.color }}",
        extendedProps: {
          materia_id: "{{ e.materia_id }}",
          can_edit: {% if e.can_edit %}true{% else %}false{% endif %}
          }
        },
    {% endfor %}
      ],
    eventClick: function (info) {
      if (info.event.extendedProps.can_edit) {
        // Allow default behavior (navigate to URL)
      } else {
        info.jsEvent.preventDefault(); // Don't navigate if student
      }
    },
    windowResize: function (view) {
      if (window.innerWidth < 768) {
        calendar.setOption('headerToolbar', {
          left: 'prev,next',
          center: 'title',
          right: 'dayGridMonth,timeGridDay'
        });
        calendar.setOption('aspectRatio', 0.8);
      } else {
        calendar.setOption('headerToolbar', {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        });
        calendar.setOption('aspectRatio', 1.35);
      }
    }
    });
  calendar.render();
  });
</script>
<style>
  #calendar {
    max-width: 100%;
    margin: 0 auto;
    font-family: var(--font-family);
  }

  .fc-event {
    cursor: pointer;
  }

  /* Mobile adjustments for calendar */
  @media (max-width: 768px) {
    .fc-toolbar {
      flex-direction: column;
      gap: 10px;
    }

    .fc-toolbar-title {
      font-size: 1.2em !important;
    }
  }
</style>
{% endif %}

<h2>Diplomaturas</h2>

<div class="grid">
  {% for d in diplomaturas %}
  <div class="card">
    <h3>{{ d.nombre }}</h3>
    <p class="muted">CÃ³digo: {{ d.codigo }}</p>
    <p><a class="btn secondary small" href="{% url 'asistencias:calendario_diplomatura' d.id %}">ğŸ“… Ver Calendario</a>
    </p>

    <ul>
      {% for m in d.materias.all %}
      <li>
        {{ m.nombre }} â€” <a href="{% url 'asistencias:ver_clases' m.id %}">ver clases</a>
      </li>
      {% endfor %}
    </ul>
  </div>
  {% empty %}
  <p>No tenÃ©s diplomaturas asignadas.</p>
  {% endfor %}
</div>

{% endblock %}